import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:yksgunluk/dumenden/app_state.dart' as app;
import 'package:yksgunluk/ekranlar/home_page.dart';
import 'package:yksgunluk/icon_penceler/ozellestirme_ekrani.dart';
import 'package:yksgunluk/ogretmen/ogretmen.dart';
import 'package:yksgunluk/giris/auth_screen.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:yksgunluk/teacher_mode.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'firebase_options.dart';

// FCM arka plan mesaj i≈üleyici
@pragma('vm:entry-point')
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  print("Arka planda bildirim alƒ±ndƒ±: ${message.messageId}");
}

// Bildirim kanalƒ± tanƒ±mƒ±
const AndroidNotificationChannel channel = AndroidNotificationChannel(
  'high_importance_channel',
  'Y√ºksek √ñncelikli Bildirimler',
  description: 'Mentor istekleri ve √∂nemli bildirimler i√ßin kanal',
  importance: Importance.high,
  playSound: true,
);

final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin = 
  FlutterLocalNotificationsPlugin();

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // üî• AdMob'u ba≈ülat
  await MobileAds.instance.initialize();
  print('üî• AdMob ba≈ülatƒ±ldƒ±');
  
  // üî• Premium durumunu y√ºkle
  await PremiumManager.loadPremiumStatus();
  
  FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);
  
  await SystemChrome.setEnabledSystemUIMode(
    SystemUiMode.immersiveSticky,
    overlays: []
  );
  
  SystemChrome.setSystemUIOverlayStyle(
    const SystemUiOverlayStyle(
      statusBarColor: Colors.transparent,
      systemNavigationBarColor: Colors.transparent,
      statusBarIconBrightness: Brightness.dark,
      systemNavigationBarIconBrightness: Brightness.dark,
      systemNavigationBarDividerColor: Colors.transparent,
    ),
  );

  SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
    DeviceOrientation.portraitDown,
  ]);

  if (Firebase.apps.isEmpty) {
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );
  }
  
  try {
    await ThemeManager.loadColors();
    print('üé® Ana tema y√ºklendi: Primary: ${ThemeManager.primaryColor}, Secondary: ${ThemeManager.secondaryColor}');
  } catch (e) {
    print('‚ùå Tema y√ºklenirken hata: $e');
  }
  
  await flutterLocalNotificationsPlugin
      .resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>()
      ?.createNotificationChannel(channel);
  
  await _initializeNotifications();
  
  await FirebaseMessaging.instance.setForegroundNotificationPresentationOptions(
    alert: true,
    badge: true,
    sound: true,
  );
  
  await FirebaseMessaging.instance.requestPermission(
    alert: true,
    announcement: false,
    badge: true,
    carPlay: false,
    criticalAlert: false,
    provisional: false,
    sound: true,
  );

  final prefs = await SharedPreferences.getInstance();
  final isLoggedIn = prefs.getBool('isLoggedIn') ?? false;
  final userType = prefs.getString('userType') ?? '√ñƒürenci';

  // üî• Premium deƒüilse reklamƒ± y√ºkle
  if (!PremiumManager.isPremium) {
    AdMobHelper.loadInterstitialAd();
    print('üÜì Free kullanƒ±cƒ± - reklamlar aktif');
  } else {
    print('üëë Premium kullanƒ±cƒ± - reklamlar devre dƒ±≈üƒ±');
  }

  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(
          create: (context) => app.AppState(isLoggedIn: isLoggedIn, userType: userType),
        ),
        ChangeNotifierProvider(
          create: (context) => TeacherModeProvider(),
        ),
        ChangeNotifierProvider(
          create: (context) => PremiumManager(),
        ),
      ],
      child: MyApp(),
    ),
  );
}

Future<void> _initializeNotifications() async {
  const AndroidInitializationSettings initializationSettingsAndroid = 
      AndroidInitializationSettings('app_icon');
  
  final DarwinInitializationSettings initializationSettingsDarwin = 
      DarwinInitializationSettings(
        requestAlertPermission: true,
        requestBadgePermission: true,
        requestSoundPermission: true,
      );
  
  final InitializationSettings initializationSettings = InitializationSettings(
    android: initializationSettingsAndroid,
    iOS: initializationSettingsDarwin,
  );
  
  await flutterLocalNotificationsPlugin.initialize(
    initializationSettings,
    onDidReceiveNotificationResponse: (NotificationResponse response) async {
      print('Bildirime tƒ±klandƒ±: ${response.payload}');
    },
  );
}

class MyApp extends StatefulWidget {
  const MyApp({Key? key}) : super(key: key);

  @override
  State<MyApp> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  @override
  void initState() {
    super.initState();
    _getFCMToken();
    _setupForegroundMessaging();
    _setupOnMessageOpenedApp();
  }
  
  Future<void> _getFCMToken() async {
    String? token = await FirebaseMessaging.instance.getToken();
    print('FCM Token: $token');
  }
  
  void _setupForegroundMessaging() {
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      RemoteNotification? notification = message.notification;
      AndroidNotification? android = message.notification?.android;
      
      print('√ñn planda bildirim alƒ±ndƒ±: ${notification?.title}');
      
      if (notification != null && android != null) {
        flutterLocalNotificationsPlugin.show(
          notification.hashCode,
          notification.title,
          notification.body,
          NotificationDetails(
            android: AndroidNotificationDetails(
              channel.id,
              channel.name,
              channelDescription: channel.description,
              icon: 'app_icon',
              importance: Importance.max,
              priority: Priority.high,
            ),
            iOS: const DarwinNotificationDetails(
              presentAlert: true,
              presentBadge: true,
              presentSound: true,
            ),
          ),
          payload: message.data['type'] ?? '',
        );
      }
    });
  }
  
  void _setupOnMessageOpenedApp() {
    FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
      print('Bildirime tƒ±klandƒ±!');
      print('Mesaj verisi: ${message.data}');
      
      final appState = Provider.of<app.AppState>(context, listen: false);
      if (appState.isLoggedIn && message.data['type'] == 'mentor_istegi') {
        // Y√∂nlendirme i≈ülemleri
      }
    });
  }
  
  @override
  Widget build(BuildContext context) {
    _ensureFullScreen();
    
    final appState = Provider.of<app.AppState>(context);
    
    return MaterialApp(
      title: 'YKS G√ºnl√ºƒü√ºm',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        primarySwatch: Colors.blue,
        scaffoldBackgroundColor: Colors.white,
        cardColor: Colors.white,
        dialogBackgroundColor: Colors.white,
        appBarTheme: const AppBarTheme(
          systemOverlayStyle: SystemUiOverlayStyle.dark,
          backgroundColor: Colors.transparent,
          elevation: 0,
        ),
        brightness: Brightness.light,
        textTheme: const TextTheme(
          bodyLarge: TextStyle(color: Colors.black87),
          bodyMedium: TextStyle(color: Colors.black87),
          titleLarge: TextStyle(color: Colors.black87),
          titleMedium: TextStyle(color: Colors.black87),
        ),
        bottomNavigationBarTheme: const BottomNavigationBarThemeData(
          backgroundColor: Colors.white,
          selectedItemColor: Colors.blue,
          unselectedItemColor: Colors.grey,
        ),
      ),
      builder: (context, child) {
        return AnnotatedRegion<SystemUiOverlayStyle>(
          value: const SystemUiOverlayStyle(
            statusBarColor: Colors.transparent,
            systemNavigationBarColor: Colors.transparent,
            statusBarIconBrightness: Brightness.dark,
            systemNavigationBarIconBrightness: Brightness.dark,
            systemNavigationBarDividerColor: Colors.transparent,
          ),
          child: child!,
        );
      },
      home: _buildHomeScreen(appState),
    );
  }

  Widget _buildHomeScreen(app.AppState appState) {
    if (!appState.isLoggedIn) {
      return AuthScreen();
    }
    
    if (appState.userType == '√ñƒüretmen') {
      return OgretmenPaneli();
    } else {
      return AnaEkran();
    }
  }
  
  void _ensureFullScreen() {
    SystemChrome.setEnabledSystemUIMode(
      SystemUiMode.immersiveSticky,
      overlays: []
    );
  }
}

class FullScreenHelper {
  static void enableFullScreen() {
    SystemChrome.setEnabledSystemUIMode(
      SystemUiMode.immersiveSticky,
      overlays: []
    );
  }
  
  static void disableFullScreen() {
    SystemChrome.setEnabledSystemUIMode(
      SystemUiMode.edgeToEdge,
      overlays: [SystemUiOverlay.top, SystemUiOverlay.bottom]
    );
  }
}

class FCMHelper {
  static Future<void> saveUserFCMToken(String userId) async {
    try {
      String? token = await FirebaseMessaging.instance.getToken();
      if (token != null) {
        await FirebaseFirestore.instance
            .collection('users')
            .doc(userId)
            .update({
          'fcmToken': token,
        });
        print('FCM Token kaydedildi: $token');
      }
    } catch (e) {
      print('FCM token kaydedilirken hata: $e');
    }
  }
  
  static Future<void> subscribeToTopic(String topic) async {
    await FirebaseMessaging.instance.subscribeToTopic(topic);
  }
  
  static Future<void> unsubscribeFromTopic(String topic) async {
    await FirebaseMessaging.instance.unsubscribeFromTopic(topic);
  }
  
  static Future<void> showLocalNotification({
    required int id,
    required String title,
    required String body,
    String? payload,
  }) async {
    await flutterLocalNotificationsPlugin.show(
      id,
      title,
      body,
      NotificationDetails(
        android: AndroidNotificationDetails(
          channel.id,
          channel.name,
          channelDescription: channel.description,
          importance: Importance.high,
          priority: Priority.high,
          icon: 'app_icon',
        ),
        iOS: const DarwinNotificationDetails(
          presentAlert: true,
          presentBadge: true,
          presentSound: true,
        ),
      ),
      payload: payload,
    );
  }
}

// üëë PREMIUM Y√ñNETƒ∞M Sƒ∞STEMƒ∞
class PremiumManager extends ChangeNotifier {
  static bool _isPremium = false;
  static DateTime? _premiumExpiryDate;
  static String? _purchaseId;
  
  // Getter'lar
  static bool get isPremium => _isPremium;
  static DateTime? get premiumExpiryDate => _premiumExpiryDate;
  static String? get purchaseId => _purchaseId;
  
  // Premium durumunu SharedPreferences'dan y√ºkle
  static Future<void> loadPremiumStatus() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      _isPremium = prefs.getBool('isPremium') ?? false;
      
      final expiryString = prefs.getString('premiumExpiryDate');
      if (expiryString != null) {
        _premiumExpiryDate = DateTime.parse(expiryString);
        
        // S√ºre dolmu≈ü mu kontrol et
        if (_premiumExpiryDate!.isBefore(DateTime.now())) {
          print('‚ö†Ô∏è Premium s√ºresi dolmu≈ü, durumu g√ºncelleniyor...');
          await setPremiumStatus(false);
        }
      }
      
      _purchaseId = prefs.getString('purchaseId');
      
      print('üëë Premium durum y√ºklendi: $_isPremium');
      if (_premiumExpiryDate != null) {
        print('üìÖ Premium biti≈ü tarihi: $_premiumExpiryDate');
      }
    } catch (e) {
      print('‚ùå Premium durum y√ºklenirken hata: $e');
      _isPremium = false;
    }
  }
  
  // Premium durumunu ayarla
  static Future<void> setPremiumStatus(bool premium, {DateTime? expiryDate, String? purchaseId}) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      
      _isPremium = premium;
      _premiumExpiryDate = expiryDate;
      _purchaseId = purchaseId;
      
      await prefs.setBool('isPremium', premium);
      
      if (expiryDate != null) {
        await prefs.setString('premiumExpiryDate', expiryDate.toIso8601String());
      } else {
        await prefs.remove('premiumExpiryDate');
      }
      
      if (purchaseId != null) {
        await prefs.setString('purchaseId', purchaseId);
      } else {
        await prefs.remove('purchaseId');
      }
      
      print('üëë Premium durum g√ºncellendi: $premium');
      
      // Reklam durumunu g√ºncelle
      if (premium) {
        AdMobHelper.disableAds();
        print('üö´ Reklamlar devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±');
      } else {
        AdMobHelper.enableAds();
        print('üì∫ Reklamlar etkinle≈ütirildi');
      }
      
    } catch (e) {
      print('‚ùå Premium durum kaydedilirken hata: $e');
    }
  }
  
  // Premium s√ºresini kontrol et
  static bool isPremiumValid() {
    if (!_isPremium) return false;
    
    if (_premiumExpiryDate == null) return true; // Sƒ±nƒ±rsƒ±z premium
    
    return _premiumExpiryDate!.isAfter(DateTime.now());
  }
  
  // Kalan premium s√ºresini al
  static Duration? getRemainingPremiumTime() {
    if (!_isPremium || _premiumExpiryDate == null) return null;
    
    final now = DateTime.now();
    if (_premiumExpiryDate!.isBefore(now)) return Duration.zero;
    
    return _premiumExpiryDate!.difference(now);
  }
  
  // Premium bilgilerini temizle
  static Future<void> clearPremiumStatus() async {
    await setPremiumStatus(false);
  }
}

// üî• PREMIUM DESTEKLƒ∞ AdMob Helper
class AdMobHelper {
  static const String _interstitialAdId = 'ca-app-pub-1776033348127199/7211314486';
  
  static InterstitialAd? _interstitialAd;
  static bool _isInterstitialAdReady = false;
  static int _actionCount = 0;
  static DateTime? _lastAdShown;
  static bool _adsEnabled = true; // Reklamlar aktif mi?
  
  static const int MIN_MINUTES_BETWEEN_ADS = 1;
  static const int MIN_ACTIONS_BEFORE_AD = 8;
  
  // Reklamlarƒ± devre dƒ±≈üƒ± bƒ±rak (Premium i√ßin)
  static void disableAds() {
    _adsEnabled = false;
    _disposeCurrentAd();
    print('üö´ Reklamlar devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±');
  }
  
  // Reklamlarƒ± etkinle≈ütir
  static void enableAds() {
    _adsEnabled = true;
    loadInterstitialAd();
    print('üì∫ Reklamlar etkinle≈ütirildi');
  }
  
  // Mevcut reklamƒ± temizle
  static void _disposeCurrentAd() {
    _interstitialAd?.dispose();
    _interstitialAd = null;
    _isInterstitialAdReady = false;
  }
  
  static Future<void> loadInterstitialAd() async {
    // Premium kontrol√º
    if (!_adsEnabled || PremiumManager.isPremium) {
      print('üëë Premium kullanƒ±cƒ± - reklam y√ºklenmedi');
      return;
    }
    
    try {
      await InterstitialAd.load(
        adUnitId: _interstitialAdId,
        request: const AdRequest(),
        adLoadCallback: InterstitialAdLoadCallback(
          onAdLoaded: (InterstitialAd ad) {
            print('üéØ Interstitial reklam y√ºklendi');
            _interstitialAd = ad;
            _isInterstitialAdReady = true;
            
            _interstitialAd!.setImmersiveMode(true);
            _interstitialAd!.fullScreenContentCallback = FullScreenContentCallback(
              onAdShowedFullScreenContent: (InterstitialAd ad) {
                print('üî• Interstitial reklam g√∂sterildi');
              },
              onAdDismissedFullScreenContent: (InterstitialAd ad) {
                print('‚úÖ Interstitial reklam kapatƒ±ldƒ±');
                ad.dispose();
                _isInterstitialAdReady = false;
                _lastAdShown = DateTime.now();
                
                // Premium kontrol√º ile yeni reklam y√ºkle
                Future.delayed(Duration(seconds: 15), () {
                  if (!PremiumManager.isPremium) {
                    loadInterstitialAd();
                  }
                });
              },
              onAdFailedToShowFullScreenContent: (InterstitialAd ad, AdError error) {
                print('‚ùå Interstitial reklam g√∂sterilemedi: $error');
                ad.dispose();
                _isInterstitialAdReady = false;
                loadInterstitialAd();
              },
            );
          },
          onAdFailedToLoad: (LoadAdError error) {
            print('‚ùå Interstitial reklam y√ºklenemedi: $error');
            _interstitialAd = null;
            _isInterstitialAdReady = false;
            
            Future.delayed(Duration(seconds: 30), () {
              if (!PremiumManager.isPremium) {
                loadInterstitialAd();
              }
            });
          },
        ),
      );
    } catch (e) {
      print('‚ùå AdMob y√ºkleme hatasƒ±: $e');
    }
  }
  
  // üëë PREMIUM KONTROLL√ú reklam g√∂sterme
  static void tryShowAd() {
    // Premium kontrol√º - EN √ñNEMLƒ∞!
    if (!_adsEnabled || PremiumManager.isPremium) {
      print('üëë Premium kullanƒ±cƒ± - reklam g√∂sterilmedi');
      return;
    }
    
    _actionCount++;
    
    final now = DateTime.now();
    final timeSinceLastAd = _lastAdShown == null ? 
        Duration(minutes: 10) : now.difference(_lastAdShown!);
    
    final canShowAd = _actionCount >= MIN_ACTIONS_BEFORE_AD && 
        timeSinceLastAd.inMinutes >= MIN_MINUTES_BETWEEN_ADS && 
        _isInterstitialAdReady && 
        _interstitialAd != null;
    
    if (canShowAd) {
      _interstitialAd!.show();
      _actionCount = 0;
      print('üöÄ REKLAM g√∂sterildi! Sonraki reklam: ${now.add(Duration(minutes: MIN_MINUTES_BETWEEN_ADS))}');
    } else {
      print('‚ö†Ô∏è Reklam g√∂sterme ko≈üullarƒ± saƒülanmadƒ±');
      print('   üéØ Aksiyon sayƒ±sƒ±: $_actionCount/$MIN_ACTIONS_BEFORE_AD');
      print('   ‚è∞ Son reklamdan ge√ßen s√ºre: ${timeSinceLastAd.inMinutes}/$MIN_MINUTES_BETWEEN_ADS dakika');
      print('   üì± Reklam hazƒ±r: $_isInterstitialAdReady');
      
      if (!_isInterstitialAdReady && !PremiumManager.isPremium) {
        loadInterstitialAd();
      }
    }
  }
  
  static void showInterstitialAd() {
    if (!_adsEnabled || PremiumManager.isPremium) {
      print('üëë Premium kullanƒ±cƒ± - manuel reklam g√∂sterilmedi');
      return;
    }
    
    if (_isInterstitialAdReady && _interstitialAd != null) {
      _interstitialAd!.show();
      _interstitialAd = null;
      _isInterstitialAdReady = false;
    } else {
      print('‚ö†Ô∏è Interstitial reklam hen√ºz hazƒ±r deƒüil');
      loadInterstitialAd();
    }
  }
  
  static bool isAdReady() {
    if (!_adsEnabled || PremiumManager.isPremium) return false;
    return _isInterstitialAdReady && _interstitialAd != null;
  }
  
  static Map<String, dynamic> getAdStats() {
    return {
      'isPremium': PremiumManager.isPremium,
      'adsEnabled': _adsEnabled,
      'actionCount': _actionCount,
      'requiredActions': MIN_ACTIONS_BEFORE_AD,
      'isAdReady': _isInterstitialAdReady,
      'lastAdShown': _lastAdShown?.toString() ?? 'Hi√ß g√∂sterilmedi',
      'nextAdAvailable': _lastAdShown != null ? 
          _lastAdShown!.add(Duration(minutes: MIN_MINUTES_BETWEEN_ADS)).toString() : '≈ûimdi',
      'waitTime': '${MIN_MINUTES_BETWEEN_ADS} dakika',
    };
  }
}

// üéØ PREMIUM KONTROLL√ú reklam g√∂sterme helper'larƒ±
class AdStrategy {
  static void onPageTransition() {
    print('üìÑ Sayfa ge√ßi≈üi - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onFeatureUsed() {
    print('‚öôÔ∏è √ñzellik kullanƒ±ldƒ± - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onAchievement() {
    print('üèÜ Ba≈üarƒ± kazanƒ±ldƒ± - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onMenuOpen() {
    print('üìã Men√º a√ßƒ±ldƒ± - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onDailyComplete() {
    print('‚úÖ G√ºnl√ºk tamamlandƒ± - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onStudyStart() {
    print('üìö √áalƒ±≈üma ba≈üladƒ± - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
  
  static void onStudyEnd() {
    print('‚è∞ √áalƒ±≈üma bitti - reklam kontrol ediliyor...');
    AdMobHelper.tryShowAd();
  }
}